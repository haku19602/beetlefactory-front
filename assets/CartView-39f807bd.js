import{_ as Z,K as J,N as O,L as ee,r as A,c as X,o as te,P as oe,Q as i,R as v,h as t,T as o,a3 as se,$ as u,Y as l,U as k,W as ae,X as le,Z as n,a2 as p,V as y,G as re,H as ne,a9 as ce,aa as P,S as z,a0 as de,ag as j,a4 as ue,a5 as ie}from"./index-5c103a3f.js";import{c as pe,a as b,u as me,d as x,V as _e}from"./index.esm-a3ca4ea2.js";import{V as ve}from"./VContainer-95b6aa67.js";import{a as I,V as r}from"./VRow-c1778a5a.js";import{V as E}from"./VChip-ca8043fe.js";import{V as G}from"./VDivider-8b51d44a.js";import{V as he}from"./VSelect-9b3f2fc5.js";import{V as ye}from"./VTextarea-91d46fb4.js";import"./VList-1bd5f902.js";const V=C=>(ue("data-v-4cc46684"),C=C(),ie(),C),fe={style:{height:"100%"},class:"bg-back"},ge={key:0,class:"text-center text-grey-darken-1"},ke={key:0},be={class:"text-grey-darken-1"},xe={key:1},Ve={class:"text-decoration-line-through"},Ce=V(()=>n("p",{class:"text-secondary text-subtitle-2"},"商品已下架 或 暫時無庫存",-1)),we={class:"text-grey-darken-1"},Se={key:0,class:"text-secondary text-subtitle-2"},Ne={class:"text-h5 font-weight-bold"},Te=V(()=>n("p",{class:"text-body-2 text-grey-darken-1"},"(運費另計)",-1)),Be={class:"text-h5 font-weight-bold"},qe={key:0},$e=V(()=>n("b",{class:"text-h6 font-weight-bold"},"110",-1)),Le={key:1},Pe=V(()=>n("b",{class:"text-h6 font-weight-bold"},"70",-1)),ze={key:2},Ie=V(()=>n("b",{class:"text-h6 font-weight-bold"},"0",-1)),Me={__name:"CartView",setup(C){const{apiAuth:w}=se(),h=J(),m=O(),S=ee(),_=A([]),M=s=>m.likes.includes(s),U=X(()=>_.value.reduce((s,a)=>s+a.quantity*a.product.price,0)),N=A(!1),F=["黑貓","7-11 交貨便","面交"],H=X(()=>_.value.length>0&&!_.value.some(s=>!s.product.sell)&&!_.value.some(s=>s.product.stock<=0)),T=async(s,a)=>{var c,e;if(!m.isLogin){S.push("/login");return}try{const{data:d}=await w.patch("/users/cart",{product:s,quantity:a});m.cart=d.result;const g=_.value.findIndex(Y=>Y.product._id===s);_.value[g].quantity+=a,_.value[g].quantity<=0&&_.value.splice(g,1),h({text:"修改成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"primary",location:"bottom"}})}catch(d){const g=((e=(c=d==null?void 0:d.response)==null?void 0:c.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";h({text:g,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"secondary",location:"bottom"}})}},R=async s=>{var a,c;if(!m.isLogin){S.push("/login");return}try{await w.patch("/users/likes",{product:s});const e=m.likes.findIndex(d=>d===s);e>-1?m.likes.splice(e,1):m.likes.push(s),h({text:M(s)?"已加入收藏！":"已取消收藏！",showCloseButton:!1,snackbarProps:{timeout:1e3,color:"back",location:"center"}})}catch(e){console.log(e);const d=((c=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";h({text:d,showCloseButton:!1,snackbarProps:{timeout:1e3,color:"secondary",location:"center"}})}},K=pe({name:b().required("收件人姓名 必填"),phone:b().required("收件人電話 必填").min(10,"手機號碼格式錯誤").max(10,"手機號碼格式錯誤"),delivery:b().required("運送方式 必填").test("isCategory","運送方式錯誤",s=>F.includes(s)),address:b().required("收件地址 必填"),note:b()}),{handleSubmit:Q,isSubmitting:D}=me({validationSchema:K,initialValues:{name:"",phone:"",delivery:"",address:"",note:""}}),B=x("name"),q=x("phone"),f=x("delivery"),$=x("address"),L=x("note"),W=Q(async s=>{var a,c;try{await w.post("/orders",{name:s.name,phone:s.phone,delivery:s.delivery,address:s.address,note:s.note}),m.cart=0,S.push("/myorders"),h({text:"訂單送出成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"back",location:"bottom"}})}catch(e){const d=((c=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";h({text:d,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"secondary",location:"bottom"}}),setTimeout(()=>{S.go(0)},3e3)}});return te(async()=>{var s,a;try{const{data:c}=await w.get("/users/cart");_.value.push(...c.result)}catch(c){const e=((a=(s=c==null?void 0:c.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";h({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"secondary",location:"bottom"}})}}),(s,a)=>{const c=oe("RouterLink");return i(),v("div",fe,[t(ve,null,{default:o(()=>[t(I,{class:"justify-center"},{default:o(()=>[t(r,{cols:"12",md:"11",class:"text-center mt-8"},{default:o(()=>[t(E,{class:"vchip-space text-body-2 text-md-body-1",variant:"outlined",size:"large",color:"primary","append-icon":"mdi-check-circle-outline"},{default:o(()=>[u("購物車 > 填寫運送資訊 > 送出訂單 > 付款")]),_:1}),t(G,{class:"mx-3 my-5"})]),_:1}),t(r,{cols:"12",md:"11"},{default:o(()=>[l(m).cart===0?(i(),v("p",ge,"----- 購物車沒有商品 -----")):k("",!0),(i(!0),v(ae,null,le(_.value,e=>(i(),z(I,{key:e._id},{default:o(()=>[t(r,{cols:"6",lg:"3"},{default:o(()=>[t(c,{to:"/products/"+e.product._id},{default:o(()=>[t(de,{src:e.product.image,"aspect-ratio":"1"},null,8,["src"])]),_:2},1032,["to"])]),_:2},1024),t(r,{cols:"6",lg:"9",class:"d-flex flex-column flex-lg-row"},{default:o(()=>[t(r,{lg:"4"},{default:o(()=>[e.product.sell&&e.product.stock>0?(i(),v("div",ke,[n("h3",null,p(e.product.name),1),n("p",be,"NT. "+p(e.product.price),1)])):(i(),v("div",xe,[n("h3",Ve,p(e.product.name),1),Ce,n("p",we,"NT. "+p(e.product.price),1)])),t(E,{density:"comfortable",class:"mt-2",variant:"outlined",color:"primary"},{default:o(()=>[u(p(e.product.category),1)]),_:2},1024)]),_:2},1024),t(r,null,{default:o(()=>[n("p",{class:j(e.product.sell&&e.product.stock>0?[]:["text-grey"])},[u(" 數量： "),t(y,{icon:"mdi-minus",variant:"text",density:"compact",color:"primary",class:"mb-1",disabled:!e.product.sell||e.product.stock<=0,onClick:d=>T(e.product._id,-1)},null,8,["disabled","onClick"]),u(" "+p(e.quantity)+" ",1),t(y,{icon:"mdi-plus",variant:"text",density:"compact",color:"primary",class:"mb-1",disabled:!e.product.sell||e.product.stock<=0,onClick:d=>T(e.product._id,1)},null,8,["disabled","onClick"])],2),e.product.stock<=5&&e.product.stock>0?(i(),v("p",Se,"最後 "+p(e.product.stock)+" 組！",1)):k("",!0)]),_:2},1024),t(r,null,{default:o(()=>[n("p",{class:j(e.product.sell&&e.product.stock>0?[]:["text-grey"])},[u("小計：NT. "),n("b",null,p(e.product.price*e.quantity),1)],2)]),_:2},1024),t(r,{class:"d-flex",lg:"2"},{default:o(()=>[M(e.product._id)?(i(),z(y,{key:0,icon:"mdi-heart",size:"small",color:"secondary",variant:"outlined",class:"me-3",onClick:d=>R(e.product._id)},null,8,["onClick"])):(i(),z(y,{key:1,icon:"mdi-heart-outline",size:"small",color:"secondary",variant:"outlined",class:"me-3",onClick:d=>R(e.product._id)},null,8,["onClick"])),t(y,{icon:"mdi-delete",size:"small",color:"secondary",onClick:d=>T(e.product._id,e.quantity*-1)},null,8,["onClick"])]),_:2},1024)]),_:2},1024),t(G,{class:"mx-3 my-3"})]),_:2},1024))),128))]),_:1}),t(r,{cols:"12",md:"11",class:"text-end pe-10"},{default:o(()=>[n("p",null,[u("共 "),n("b",null,p(l(m).cart),1),u(" 件商品")]),n("p",null,[u("總計：NT. "),n("b",Ne,p(U.value),1)]),Te]),_:1}),t(r,{cols:"12",md:"11",class:"text-end pe-10 mb-5"},{default:o(()=>[t(y,{color:"primary",size:"large",rounded:"","append-icon":"mdi-arrow-down-circle",onClick:a[0]||(a[0]=e=>N.value=!N.value)},{default:o(()=>[u("填寫運送資訊")]),_:1})]),_:1}),t(r,{cols:"12",md:"11",class:"text-end mb-16 pe-10"},{default:o(()=>[re(t(_e,{disabled:l(D),onSubmit:ce(l(W),["prevent"])},{default:o(()=>[t(I,null,{default:o(()=>[t(r,{cols:"12",md:"4"},{default:o(()=>[t(P,{"prepend-icon":"mdi-account-box-outline",label:"收件人姓名",placeholder:"王X明",hint:"請填寫真實姓名以利收件",variant:"outlined",density:"compact",modelValue:l(B).value.value,"onUpdate:modelValue":a[1]||(a[1]=e=>l(B).value.value=e),"error-messages":l(B).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"4"},{default:o(()=>[t(P,{"prepend-icon":"mdi-phone-outline",label:"收件人電話",placeholder:"0912345678",variant:"outlined",density:"compact",modelValue:l(q).value.value,"onUpdate:modelValue":a[2]||(a[2]=e=>l(q).value.value=e),"error-messages":l(q).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"4"},{default:o(()=>[t(he,{"prepend-icon":"mdi-package-variant-closed-check",label:"運送方式",variant:"outlined",density:"compact",items:F,modelValue:l(f).value.value,"onUpdate:modelValue":a[3]||(a[3]=e=>l(f).value.value=e),"error-messages":l(f).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"12"},{default:o(()=>[t(P,{"prepend-icon":"mdi-map-marker-outline",label:"收件地址",placeholder:"請填寫宅配地址 或 7-11 門市，面交請填寫「面交」",variant:"outlined",density:"compact",modelValue:l($).value.value,"onUpdate:modelValue":a[4]||(a[4]=e=>l($).value.value=e),"error-messages":l($).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12"},{default:o(()=>[t(ye,{"prepend-icon":"mdi-text",label:"訂單備註",variant:"outlined",density:"compact",clearable:"","auto-grow":"",modelValue:l(L).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>l(L).value.value=e),"error-messages":l(L).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12"},{default:o(()=>[n("p",null,[u("總計：NT. "),n("b",Be,p(U.value),1)]),l(f).value.value==="黑貓"?(i(),v("p",qe,[u("運費：NT. "),$e])):k("",!0),l(f).value.value==="7-11 交貨便"?(i(),v("p",Le,[u("運費：NT. "),Pe])):k("",!0),l(f).value.value==="面交"?(i(),v("p",ze,[u("運費：NT. "),Ie])):k("",!0)]),_:1}),t(r,{cols:"12"},{default:o(()=>[t(y,{type:"submit",color:"primary",size:"large",rounded:"","append-icon":"mdi-arrow-right-circle",disabled:!H.value,loading:l(D)},{default:o(()=>[u("送出訂單")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"]),[[ne,N.value]])]),_:1})]),_:1})]),_:1})])}}},He=Z(Me,[["__scopeId","data-v-4cc46684"]]);export{He as default};
