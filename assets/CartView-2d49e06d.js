import{_ as O,X as Q,Z as W,Y as ee,x as F,o as R,A as te,a0 as ae,a1 as v,a2 as f,c as t,a4 as s,ad as oe,aa as p,a8 as l,a5 as A,a6 as se,a7 as le,a9 as d,ac as m,J as y,T as re,U as ce,aj as ne,ak as $,a3 as z,V as de,aq as D,ae as ue,af as ie}from"./index-e0d6e017.js";import{c as pe,a as g,u as me,d as h,V as ve}from"./index.esm-3d659294.js";import{V as _e}from"./VContainer-986f0775.js";import{a as I,V as r}from"./VRow-c076aebb.js";import{V as j}from"./VChip-89bc9a6d.js";import{V as X}from"./VDivider-351f0374.js";import{V as ye}from"./VSelect-a15f96d3.js";import{V as fe}from"./VTextarea-42e3035e.js";import"./VList-7d12ec1b.js";const E=b=>(ue("data-v-7dd2aac3"),b=b(),ie(),b),ke={style:{height:"100%"},class:"bg-back"},ge={key:0,class:"text-center text-grey-darken-1"},he={key:0},be={class:"text-grey-darken-1"},xe={key:1},Ve={class:"text-decoration-line-through"},Ce=E(()=>d("p",{class:"text-secondary text-subtitle-2"},"商品已下架 或 暫時無庫存",-1)),we={class:"text-grey-darken-1"},Se={key:0,class:"text-secondary text-subtitle-2"},Be={class:"text-h5 font-weight-bold"},qe=E(()=>d("p",{class:"text-body-2 text-grey-darken-1"},"(運費另計)",-1)),Te={__name:"CartView",setup(b){const{apiAuth:x}=oe(),_=Q(),u=W(),V=ee(),i=F([]),L=a=>u.likes.includes(a),J=R(()=>i.value.reduce((a,o)=>a+o.quantity*o.product.price,0)),C=F(!1),M=["黑貓","7-11 交貨便","面交"],Y=R(()=>i.value.length>0&&!i.value.some(a=>!a.product.sell)&&!i.value.some(a=>a.product.stock<=0)),w=async(a,o)=>{var c,e;if(!u.isLogin){V.push("/login");return}try{const{data:n}=await x.patch("/users/cart",{product:a,quantity:o});u.cart=n.result;const k=i.value.findIndex(K=>K.product._id===a);i.value[k].quantity+=o,i.value[k].quantity<=0&&i.value.splice(k,1),_({text:"修改成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"primary",location:"bottom"}})}catch(n){const k=((e=(c=n==null?void 0:n.response)==null?void 0:c.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";_({text:k,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"secondary",location:"bottom"}})}},P=async a=>{var o,c;if(!u.isLogin){V.push("/login");return}try{await x.patch("/users/likes",{product:a});const e=u.likes.findIndex(n=>n===a);e>-1?u.likes.splice(e,1):u.likes.push(a),_({text:L(a)?"已加入收藏！":"已取消收藏！",showCloseButton:!1,snackbarProps:{timeout:1e3,color:"back",location:"center"}})}catch(e){console.log(e);const n=((c=(o=e==null?void 0:e.response)==null?void 0:o.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";_({text:n,showCloseButton:!1,snackbarProps:{timeout:1e3,color:"secondary",location:"center"}})}},Z=pe({name:g().required("收件人姓名 必填"),phone:g().required("收件人電話 必填").min(10,"手機號碼格式錯誤").max(10,"手機號碼格式錯誤"),delivery:g().required("運送方式 必填").test("isCategory","運送方式錯誤",a=>M.includes(a)),address:g().required("收件地址 必填"),note:g()}),{handleSubmit:G,isSubmitting:U}=me({validationSchema:Z}),S=h("name"),B=h("phone"),q=h("delivery"),T=h("address"),N=h("note"),H=G(async a=>{var o,c;try{await x.post("/orders",{name:a.name,phone:a.phone,delivery:a.delivery,address:a.address,note:a.note}),u.cart=0,V.push("/myorders"),_({text:"訂單送出成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"back",location:"bottom"}})}catch(e){const n=((c=(o=e==null?void 0:e.response)==null?void 0:o.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";_({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"secondary",location:"bottom"}}),setTimeout(()=>{V.go(0)},2e3)}});return te(async()=>{var a,o;try{const{data:c}=await x.get("/users/cart");i.value.push(...c.result)}catch(c){const e=((o=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";_({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"secondary",location:"bottom"}})}}),(a,o)=>{const c=ae("RouterLink");return v(),f("div",ke,[t(_e,null,{default:s(()=>[t(I,{class:"justify-center"},{default:s(()=>[t(r,{cols:"12",md:"11",class:"text-center mt-8"},{default:s(()=>[t(j,{class:"vchip-space text-body-2 text-md-body-1",variant:"outlined",size:"large",color:"primary","append-icon":"mdi-check-circle-outline"},{default:s(()=>[p("購物車 > 填寫運送資訊 > 送出訂單 > 付款")]),_:1}),t(X,{class:"mx-3 my-5"})]),_:1}),t(r,{cols:"12",md:"11"},{default:s(()=>[l(u).cart===0?(v(),f("p",ge,"----- 購物車沒有商品 -----")):A("",!0),(v(!0),f(se,null,le(i.value,e=>(v(),z(I,{key:e._id},{default:s(()=>[t(r,{cols:"6",lg:"3"},{default:s(()=>[t(c,{to:"/products/"+e.product._id},{default:s(()=>[t(de,{src:e.product.image,"aspect-ratio":"1"},null,8,["src"])]),_:2},1032,["to"])]),_:2},1024),t(r,{cols:"6",lg:"9",class:"d-flex flex-column flex-lg-row"},{default:s(()=>[t(r,{lg:"4"},{default:s(()=>[e.product.sell&&e.product.stock>0?(v(),f("div",he,[d("h3",null,m(e.product.name),1),d("p",be,"NT. "+m(e.product.price),1)])):(v(),f("div",xe,[d("h3",Ve,m(e.product.name),1),Ce,d("p",we,"NT. "+m(e.product.price),1)])),t(j,{density:"comfortable",class:"mt-2",variant:"outlined",color:"primary"},{default:s(()=>[p(m(e.product.category),1)]),_:2},1024)]),_:2},1024),t(r,null,{default:s(()=>[d("p",{class:D(e.product.sell&&e.product.stock>0?[]:["text-grey"])},[p(" 數量： "),t(y,{icon:"mdi-minus",variant:"text",density:"compact",color:"primary",class:"mb-1",disabled:!e.product.sell||e.product.stock<=0,onClick:n=>w(e.product._id,-1)},null,8,["disabled","onClick"]),p(" "+m(e.quantity)+" ",1),t(y,{icon:"mdi-plus",variant:"text",density:"compact",color:"primary",class:"mb-1",disabled:!e.product.sell||e.product.stock<=0,onClick:n=>w(e.product._id,1)},null,8,["disabled","onClick"])],2),e.product.stock<=5&&e.product.stock>0?(v(),f("p",Se,"最後 "+m(e.product.stock)+" 組！",1)):A("",!0)]),_:2},1024),t(r,null,{default:s(()=>[d("p",{class:D(e.product.sell&&e.product.stock>0?[]:["text-grey"])},[p("小計：NT. "),d("b",null,m(e.product.price*e.quantity),1)],2)]),_:2},1024),t(r,{class:"d-flex",lg:"2"},{default:s(()=>[L(e.product._id)?(v(),z(y,{key:0,icon:"mdi-heart",size:"small",color:"secondary",variant:"outlined",class:"me-3",onClick:n=>P(e.product._id)},null,8,["onClick"])):(v(),z(y,{key:1,icon:"mdi-heart-outline",size:"small",color:"secondary",variant:"outlined",class:"me-3",onClick:n=>P(e.product._id)},null,8,["onClick"])),t(y,{icon:"mdi-delete",size:"small",color:"secondary",onClick:n=>w(e.product._id,e.quantity*-1)},null,8,["onClick"])]),_:2},1024)]),_:2},1024),t(X,{class:"mx-3 my-3"})]),_:2},1024))),128))]),_:1}),t(r,{cols:"12",md:"11",class:"text-end pe-10"},{default:s(()=>[d("p",null,[p("共 "),d("b",null,m(l(u).cart),1),p(" 件商品")]),d("p",null,[p("總計：NT. "),d("b",Be,m(J.value),1)]),qe]),_:1}),t(r,{cols:"12",md:"11",class:"text-end pe-10 mb-5"},{default:s(()=>[t(y,{color:"primary",size:"large",rounded:"","append-icon":"mdi-arrow-down-circle",onClick:o[0]||(o[0]=e=>C.value=!C.value)},{default:s(()=>[p("填寫運送資訊")]),_:1})]),_:1}),t(r,{cols:"12",md:"11",class:"text-end mb-16 pe-10"},{default:s(()=>[re(t(ve,{disabled:l(U),onSubmit:ne(l(H),["prevent"])},{default:s(()=>[t(I,null,{default:s(()=>[t(r,{cols:"12",md:"4"},{default:s(()=>[t($,{"prepend-icon":"mdi-account-box-outline",label:"收件人姓名",placeholder:"王X明",hint:"請填寫真實姓名以利收件",variant:"outlined",density:"compact",modelValue:l(S).value.value,"onUpdate:modelValue":o[1]||(o[1]=e=>l(S).value.value=e),"error-messages":l(S).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"4"},{default:s(()=>[t($,{"prepend-icon":"mdi-phone-outline",label:"收件人電話",placeholder:"0912345678",variant:"outlined",density:"compact",modelValue:l(B).value.value,"onUpdate:modelValue":o[2]||(o[2]=e=>l(B).value.value=e),"error-messages":l(B).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"4"},{default:s(()=>[t(ye,{"prepend-icon":"mdi-package-variant-closed-check",label:"運送方式",variant:"outlined",density:"compact",items:M,modelValue:l(q).value.value,"onUpdate:modelValue":o[3]||(o[3]=e=>l(q).value.value=e),"error-messages":l(q).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12",md:"12"},{default:s(()=>[t($,{"prepend-icon":"mdi-map-marker-outline",label:"收件地址",placeholder:"請填寫宅配地址 或 7-11 門市，面交請填寫「面交」",variant:"outlined",density:"compact",modelValue:l(T).value.value,"onUpdate:modelValue":o[4]||(o[4]=e=>l(T).value.value=e),"error-messages":l(T).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12"},{default:s(()=>[t(fe,{"prepend-icon":"mdi-text",label:"訂單備註",variant:"outlined",density:"compact",clearable:"","auto-grow":"",modelValue:l(N).value.value,"onUpdate:modelValue":o[5]||(o[5]=e=>l(N).value.value=e),"error-messages":l(N).errorMessage.value},null,8,["modelValue","error-messages"])]),_:1}),t(r,{cols:"12"},{default:s(()=>[t(y,{type:"submit",color:"primary",size:"large",rounded:"","append-icon":"mdi-arrow-right-circle",disabled:!Y.value,loading:l(U)},{default:s(()=>[p("送出訂單")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"]),[[ce,C.value]])]),_:1})]),_:1})]),_:1})])}}},Re=O(Te,[["__scopeId","data-v-7dd2aac3"]]);export{Re as default};
